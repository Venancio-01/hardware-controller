# Specification: Enhance Apply Ammo Flow with Cancel and Refuse Logic

## 1. Overview
本 Track 旨在增强申请供弹业务流程（Apply Ammo Flow），新增对“用户取消申请”和“控制端拒绝申请”两种场景的处理。通过引入新的状态和事件，使系统能够准确响应用户的取消操作以及管理人员的拒绝操作，并提供相应的语音反馈。

## 2. Functional Requirements

### 2.1 状态机变更 (`src/state-machines/apply-ammo-machine.ts`)

新增状态与事件以支持以下逻辑：

1.  **用户取消 (User Cancel)**
    -   **触发条件**：在 `applying` (申请中) 状态下，用户将 `CABINET1` (柜门1) 信号置为低电平（从高变低）。
    -   **行为**：状态流转回 `idle`。
    -   **语音播报**：播报“供弹结束”。
    -   **区别**：此行为不同于授权后的正常作业结束（后者播报“供弹完毕”）。

2.  **控制端拒绝 (Control Refuse)**
    -   **触发条件**：在 `applying` (申请中) 状态下，检测到 `CONTROL5` (控制端5) 信号发生变化（跳变）。
    -   **行为**：状态流转至新增的 `refused` (拒绝) 状态。
    -   **语音播报**：播报“授权未通过，请取消供弹”。

3.  **拒绝状态复位 (Refused Reset)**
    -   **触发条件**：在 `refused` 状态下，用户将 `CABINET1` 信号置为低电平（取消操作）。
    -   **行为**：状态流转回 `idle`。
    -   **语音播报**：播报“供弹结束” (保持一致性，确认流程终止)。

### 2.2 业务流变更 (`src/business-logic/apply-ammo-flow.ts`)

更新输入信号处理逻辑以驱动状态机：

-   **监听 `CONTROL5_INDEX`**：检测到变化时，向状态机发送拒绝事件（如 `REFUSE`）。
-   **区分 `CABINET1` 下降沿**：
    -   `CABINET1` 从高变低应作为通用结束信号发送给状态机（如 `FINISHED` 或 `CABINET_LOW`）。
    -   状态机需根据当前状态 (`applying` vs `idle` vs `refused`) 决定是执行“供弹结束”（取消/复位）还是“供弹完毕”（正常结束）的逻辑。

## 3. Acceptance Criteria

-   [ ] **场景 A：用户申请后取消**
    -   操作：用户触发申请 (`CABINET1` 高) -> 系统播报“已申请...” -> 用户复位 (`CABINET1` 低)。
    -   结果：系统播报“供弹结束”，状态回到 `idle`。
-   [ ] **场景 B：用户申请后被拒绝**
    -   操作：用户触发申请 -> 控制端拒绝 (`CONTROL5` 变化)。
    -   结果：系统播报“授权未通过，请取消供弹”，状态进入 `refused`。
-   [ ] **场景 C：拒绝后复位**
    -   操作：在场景 B 的基础上，用户复位 (`CABINET1` 低)。
    -   结果：系统播报“供弹结束”，状态回到 `idle`。
-   [ ] **场景 D：正常流程保持不变**
    -   操作：用户申请 -> 授权通过 -> 用户作业 -> 用户复位。
    -   结果：授权时播报“授权通过...”，复位时播报“供弹完毕”。

## 4. Out of Scope
-   修改“授权通过”后的状态逻辑（目前授权后即回 `idle`，由 `idle` 处理最终的“供弹完毕”信号，维持现状）。
