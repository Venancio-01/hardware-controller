# 状态机清单（草案）

> 基于 `docs/业务流转状态.md` 的业务逻辑流转，整理为“状态/事件/守卫/动作”清单。
> 目标：为后续决定是否引入 XState 或自研状态机提供可讨论的结构化参考。

## 1. 领域信号映射

### 输入（Input）
- I1: 供弹申请
- I2: 门磁开关
- I3: 门锁开关
- I4: 钥匙开关
- I5: 报警灯状态（反馈）
- I7: 门状态灯
- I7: 设备状态灯
- I8: 震动开关

### 输出（Output）
- O1: 授权通过
- O2: 取消报警
- O3: 授权取消
- O4: 报警灯
- O5: 开锁

## 2. 关键事件（Event）

### 人工/硬件事件
- EVT_APPLY_ON: 供弹申请按钮按下 (I1=1)
- EVT_APPLY_OFF: 供弹申请按钮复位 (I1=0)
- EVT_AUTH_PASS: 授权通过按钮按下（业务输入）
- EVT_AUTH_CANCEL: 授权取消按钮按下（业务输入）
- EVT_DOOR_OPEN: 门磁开关打开 (I2=1)
- EVT_DOOR_CLOSE: 门磁开关闭合 (I2=0)
- EVT_LOCK_OPEN: 门锁开关打开 (I3=1)
- EVT_LOCK_CLOSE: 门锁开关闭合 (I3=0)
- EVT_KEY_OPEN: 钥匙开关触发 (I4=1)
- EVT_KEY_RESET: 钥匙开关复位 (I4=0)
- EVT_VIBRATION: 震动触发 (I8=1)
- EVT_ALARM_CANCEL: 取消报警按钮按下（业务输入）

### 系统事件（超时/监控）
- EVT_TIMEOUT_AUTH: 授权等待超时
- EVT_TIMEOUT_DOOR_OPEN: 长期开门未关超时
- EVT_HEARTBEAT_LOST: 心跳异常/设备离线
- EVT_NETWORK_LOST: 网络断连
- EVT_RECOVER: 监控恢复（心跳/网络恢复）

## 3. 状态划分（State）

### A 线：正常业务流（主流程）
- S_IDLE: 初始化/待机
- S_APPLYING: 已申请，等待授权
- S_AUTHORIZED: 授权通过，已开锁
- S_DOOR_OPEN: 柜门已打开，取弹中
- S_DOOR_CLOSED: 柜门已关闭，等待复位申请
- S_FINISHED: 供弹完毕（归一到 S_IDLE）

### B 线：授权取消流程
- S_CANCEL_WAIT_RESET: 授权取消后等待复位申请

### 异常/强制干预流程
- S_KEY_ALARM: 钥匙开门报警中
- S_VIBRATION_ALARM: 震动报警中
- S_MONITOR_ALARM: 设备/网络/心跳/长期开门未关报警中

### 并行监控（建议为并行状态）
- P_MONITORING: 后台监控（心跳/网络/开门超时）

## 4. 守卫条件（Guard）
- G_APPLY_ON: I1=1
- G_APPLY_OFF: I1=0
- G_DOOR_OPEN: I2=1
- G_DOOR_CLOSE: I2=0
- G_LOCK_OPEN: I3=1
- G_LOCK_CLOSE: I3=0
- G_KEY_OPEN: I4=1
- G_KEY_RESET: I4=0
- G_VIBRATION: I8=1

## 5. 动作（Action）

### 输出控制
- ACT_GRANT: O1=1（授权通过）
- ACT_CANCEL_AUTH: O3=1（授权取消）
- ACT_UNLOCK: O5=1（开锁）
- ACT_ALARM_ON: O4=1（报警灯）
- ACT_ALARM_OFF: O4=0（报警灯）
- ACT_ALARM_CANCEL: O2=1（取消报警）

### 语音/提示
- ACT_VOICE_APPLY: “已申请，请等待授权”
- ACT_VOICE_AUTH_PASS: “授权通过，已开锁请打开柜门”
- ACT_VOICE_DOOR_OPEN: “已开门，取弹后关闭柜门，并复位按键”
- ACT_VOICE_DOOR_CLOSE: “柜门已关闭”
- ACT_VOICE_FINISH: “供弹完毕”
- ACT_VOICE_AUTH_CANCEL: “授权未通过，等待取消供弹”
- ACT_VOICE_KEY_ALARM: “钥匙开门请核实”
- ACT_VOICE_VIB_ALARM: “柜体震动报警”
- ACT_VOICE_MONITOR_ALARM: “设备状态异常”
- ACT_VOICE_ALARM_CANCEL: “取消报警”

## 6. 迁移关系（简版）

### 主流程
- S_IDLE --EVT_APPLY_ON--> S_APPLYING
- S_APPLYING --EVT_AUTH_PASS--> S_AUTHORIZED / ACT_GRANT + ACT_UNLOCK + ACT_VOICE_AUTH_PASS
- S_APPLYING --EVT_AUTH_CANCEL--> S_CANCEL_WAIT_RESET / ACT_CANCEL_AUTH + ACT_VOICE_AUTH_CANCEL
- S_AUTHORIZED --EVT_DOOR_OPEN--> S_DOOR_OPEN / ACT_VOICE_DOOR_OPEN
- S_DOOR_OPEN --EVT_DOOR_CLOSE--> S_DOOR_CLOSED / ACT_VOICE_DOOR_CLOSE
- S_DOOR_CLOSED --EVT_APPLY_OFF--> S_FINISHED / ACT_VOICE_FINISH
- S_FINISHED --(auto)--> S_IDLE

### 授权取消流
- S_CANCEL_WAIT_RESET --EVT_APPLY_OFF--> S_FINISHED / ACT_VOICE_FINISH

### 钥匙开门报警
- ANY --EVT_KEY_OPEN--> S_KEY_ALARM / ACT_ALARM_ON + ACT_VOICE_KEY_ALARM
- S_KEY_ALARM --EVT_KEY_RESET--> S_KEY_ALARM (保持报警，等待取消)
- S_KEY_ALARM --EVT_ALARM_CANCEL--> S_IDLE / ACT_ALARM_CANCEL + ACT_ALARM_OFF + ACT_VOICE_ALARM_CANCEL

### 震动报警
- ANY --EVT_VIBRATION--> S_VIBRATION_ALARM / ACT_ALARM_ON + ACT_VOICE_VIB_ALARM
- S_VIBRATION_ALARM --EVT_ALARM_CANCEL--> S_IDLE / ACT_ALARM_CANCEL + ACT_ALARM_OFF + ACT_VOICE_ALARM_CANCEL

### 监控报警（并行）
- P_MONITORING --EVT_HEARTBEAT_LOST--> S_MONITOR_ALARM / ACT_ALARM_ON + ACT_VOICE_MONITOR_ALARM
- P_MONITORING --EVT_NETWORK_LOST--> S_MONITOR_ALARM / ACT_ALARM_ON + ACT_VOICE_MONITOR_ALARM
- P_MONITORING --EVT_TIMEOUT_DOOR_OPEN--> S_MONITOR_ALARM / ACT_ALARM_ON + ACT_VOICE_MONITOR_ALARM
- S_MONITOR_ALARM --EVT_ALARM_CANCEL--> S_IDLE / ACT_ALARM_CANCEL + ACT_ALARM_OFF + ACT_VOICE_ALARM_CANCEL
- S_MONITOR_ALARM --EVT_RECOVER--> S_IDLE / ACT_ALARM_OFF

## 7. 并行/优先级建议

- 主流程与 P_MONITORING 并行。
- 任何报警类状态可视为“高优先级”，进入后暂停主流程动作，或要求显式解除后继续。
- 如果多个报警同时触发，建议统一进入一个“ALARM_ACTIVE”并记录来源列表。

## 8. XState 适配建议（简述）

- 用 `parallel` 定义主流程与监控流程。
- 用 `after` 处理超时（授权等待/开门超时）。
- 用 `invoke` 或 `services` 处理心跳/网络检测。
- 动作层统一封装为“硬件输出 + 语音播报”。
