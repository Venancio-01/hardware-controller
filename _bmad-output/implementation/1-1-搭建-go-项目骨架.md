# Story 1.1: 搭建 Go 项目骨架

Status: ready-for-dev

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 开发人员,
I want 创建符合 Go 标准布局的项目骨架,
So that 项目具有清晰的结构和可维护性。

## Acceptance Criteria

1. **Given** 新建的项目目录, **When** 创建项目结构, **Then** 生成以下目录结构:
   - `cmd/node-switch/` - 应用入口
   - `internal/config/` - 配置管理
   - `internal/api/` - HTTP API
   - `internal/logger/` - 日志模块
   - `pkg/types/` - 共享类型定义
2. **And** `go.mod` 文件包含项目依赖 (Go 1.21+)
3. **And** `main.go` 包含基本的应用启动代码
4. **And** 遵循 Go 社区标准项目布局

## Tasks / Subtasks

- [ ] Task 1: 初始化 Go 模块和基础目录结构 (AC: 1, 2)
  - [ ] 在项目根目录创建 `go.mod` 文件，指定 Go 1.21+
  - [ ] 创建 `cmd/node-switch/` 目录结构
  - [ ] 创建 `internal/config/` 目录结构
  - [ ] 创建 `internal/api/` 目录结构
  - [ ] 创建 `internal/logger/` 目录结构
  - [ ] 创建 `pkg/types/` 目录结构
- [ ] Task 2: 创建 main.go 入口文件 (AC: 3)
  - [ ] 实现 `main()` 函数
  - [ ] 添加基本的日志初始化
  - [ ] 添加优雅关闭处理
  - [ ] 添加版本信息
- [ ] Task 3: 创建基础模块文件 (AC: 4)
  - [ ] 在 `internal/logger/` 创建 `logger.go` (slog 封装)
  - [ ] 在 `pkg/types/` 创建 `config.go` (配置结构体定义)
  - [ ] 在 `internal/config/` 创建 `loader.go` (配置加载占位符)
  - [ ] 在 `internal/api/` 创建 `server.go` (HTTP 服务器占位符)
- [ ] Task 4: 验证项目可编译运行 (AC: 2, 3, 4)
  - [ ] 运行 `go build ./cmd/node-switch` 验证编译成功
  - [ ] 运行二进制文件验证基本启动和关闭

## Dev Notes

### 架构上下文

本项目是 node-switch 项目的 Go 语言重写版本。原 Node.js 版本使用 IPC 多进程架构，新版本采用 Go 的单一进程 + Goroutines 并发模型。

**核心架构原则**:
- 单一进程，使用 goroutines 实现并发
- Manager-Worker 模式协调硬件通信
- 标准库优先，最小化外部依赖

### 技术栈约束

**后端技术**:
- **运行时**: Go 1.21+
- **日志**: `log/slog` (标准库，零依赖)
- **配置**: JSON5 格式 (`github.com/titanous/json5`)
- **状态机**: `github.com/looplab/fsm` (本 story 不需要，后续使用)
- **串口**: `go.bug.st/serial` (本 story 不需要，后续使用)

**依赖管理**:
- 使用 Go modules (`go.mod`)
- 最小化第三方依赖，优先使用标准库

### 项目结构约束

```
node-switch-go/
├── cmd/
│   └── node-switch/          # 应用入口点
│       └── main.go            # 主函数
├── internal/                  # 私有代码（不可被外部导入）
│   ├── config/                # 配置管理
│   │   └── loader.go          # 配置加载（占位符，本 story 仅创建文件）
│   ├── api/                   # HTTP API
│   │   └── server.go          # HTTP 服务器（占位符，本 story 仅创建文件）
│   └── logger/                # 日志模块
│       └── logger.go          # slog 封装
├── pkg/                       # 公共库（可被外部导入）
│   └── types/                 # 共享类型定义
│       └── config.go          # 配置结构体定义
├── go.mod                     # Go 模块定义
├── go.sum                     # 依赖锁定文件
└── README.md                  # 项目说明
```

**关键规则**:
- `internal/` 中的代码绝不能被 `pkg/` 导入（Go 编译器强制）
- `cmd/` 只包含主入口，不包含业务逻辑
- 可执行代码放在 `cmd/`，库代码放在 `internal/` 或 `pkg/`

### Go 语言规范

#### 命名约定
- 文件名: `lowercase.go` 或 `lowercase_test.go`
- 接口名: 动词+`er` (如 `Reader`, `Writer`)
- 常量: `PascalCase` 或 `UPPER_SNAKE_CASE`
- 私有变量/函数: `camelCase` (小写开头)
- 导出变量/函数: `PascalCase` (大写开头)

#### Context 使用
- 所有需要取消或超时的函数必须接受 `context.Context` 作为第一个参数
- 使用 `context.WithCancel()` 管理 goroutine 生命周期
- 永远不要忽略 context 的 Done 信号

#### 错误处理
- 使用 `fmt.Errorf()` 包装错误上下文
- 错误消息使用中文（面向最终用户）或英文（面向开发者）

#### 并发模式
- 使用 `errgroup` 管理多个 goroutines 的生命周期
- 使用 `channel` 而非共享内存进行 goroutine 通信

### 具体实现要求

#### go.mod 文件
```go
module github.com/yourname/node-switch

go 1.21

require (
    github.com/titanous/json5 v0.0.0
)
```

#### main.go 基本结构
```go
package main

import (
    "context"
    "log/slog"
    "os"
    "os/signal"
    "syscall"

    "github.com/yourname/node-switch/internal/logger"
)

const version = "0.1.0"

func main() {
    // 初始化日志
    logger.Init(slog.LevelInfo)

    ctx, cancel := context.WithCancel(context.Background())
    defer cancel()

    // 优雅关闭处理
    sigCh := make(chan os.Signal, 1)
    signal.Notify(sigCh, syscall.SIGINT, syscall.SIGTERM)

    slog.Info("node-switch starting",
        "version", version,
    )

    // TODO: 后续 stories 会添加更多初始化逻辑

    select {
    case <-sigCh:
        slog.Info("shutting down...")
    case <-ctx.Done():
        slog.Info("context cancelled")
    }
}
```

#### internal/logger/logger.go
```go
package logger

import (
    "log/slog"
    "os"
)

var defaultLogger *slog.Logger

// Init 初始化默认日志器
func Init(level slog.Level) {
    opts := &slog.HandlerOptions{
        Level: level,
    }
    handler := slog.NewJSONHandler(os.Stdout, opts)
    defaultLogger = slog.New(handler)
    slog.SetDefault(defaultLogger)
}
```

#### pkg/types/config.go
```go
package types

// Config 代表系统配置
// TODO: 后续 stories 会添加详细字段
type Config struct {
    // 应用配置
    AppName string `json:"appName"`
    Version string `json:"version"`

    // 网络配置
    HTTPPort int `json:"httpPort"`

    // 硬件配置
    Hardware HardwareConfig `json:"hardware"`
}

// HardwareConfig 硬件相关配置
type HardwareConfig struct {
    // TODO: 后续添加硬件配置字段
}
```

#### internal/config/loader.go
```go
package config

import (
    "context"
    "log/slog"

    "github.com/yourname/node-switch/pkg/types"
)

// Load 加载配置文件
// TODO: Story 1.2 会实现 JSON5 加载
func Load(ctx context.Context, path string) (*types.Config, error) {
    slog.Info("config loading", "path", path)
    // 占位符实现
    return &types.Config{}, nil
}
```

#### internal/api/server.go
```go
package api

import (
    "context"
    "log/slog"
    "net/http"
    "time"
)

// Server 代表 HTTP 服务器
type Server struct {
    server *http.Server
}

// New 创建新的 HTTP 服务器
// TODO: Story 4.1 会实现完整功能
func New(addr string) *Server {
    mux := http.NewServeMux()
    srv := &http.Server{
        Addr:         addr,
        Handler:      mux,
        ReadTimeout:  5 * time.Second,
        WriteTimeout: 10 * time.Second,
        IdleTimeout:  120 * time.Second,
    }

    return &Server{server: srv}
}

// Start 启动 HTTP 服务器
func (s *Server) Start(ctx context.Context) error {
    slog.Info("http server starting", "addr", s.server.Addr)
    // TODO: 后续实现
    return nil
}

// Shutdown 优雅关闭服务器
func (s *Server) Shutdown(ctx context.Context) error {
    slog.Info("http server shutting down")
    return s.server.Shutdown(ctx)
}
```

### 项目结构规范对齐

本 story 创建的结构完全符合 Go 社区标准项目布局 (Standard Go Project Layout):
- ✅ `cmd/` - 主程序入口点
- ✅ `internal/` - 私有应用代码
- ✅ `pkg/` - 可被外部使用的库代码

无冲突或变体，严格遵循标准布局。

### 测试要求

本 story 验证项目可编译运行，暂不要求单元测试。后续 stories 会添加测试。

### 参考文档

- [Standard Go Project Layout](https://github.com/golang-standards/project-layout)
- [Go Modules Reference](https://go.dev/ref/mod)
- [log/slog Package](https://pkg.go.dev/log/slog)
- [Source: _bmad-output/planning/epics.md](../planning/epics.md#Epic-1)
- [Source: _bmad-output/project-context.md](../project-context.md)

## Dev Agent Record

### Agent Model Used

GLM-4.7 (claude-opus-4-5-20251101)

### Debug Log References

无

### Completion Notes List

- Story 创建于: 2025-12-31
- 分析来源: epics.md (Epic 1, Story 1.1), project-context.md

### File List

待创建文件:
- `go.mod`
- `cmd/node-switch/main.go`
- `internal/logger/logger.go`
- `internal/config/loader.go`
- `internal/api/server.go`
- `pkg/types/config.go`
